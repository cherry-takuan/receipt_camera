<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>WebカメラAAとWeb Serial統合デモ</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        h1, h2 { border-bottom: 2px solid #eee; padding-bottom: 5px; }
        button { padding: 10px 15px; margin: 5px 10px 5px 0; cursor: pointer; }
        #cameraFeed {
            border: 2px solid #ccc;
            width: 640px; /* 映像の幅 */
            height: 480px; /* 映像の高さ */
            display: block;
            margin-top: 10px;
            background-color: #000;
        }
        #asciiOutput {
            /* アスキーアート表示エリアのスタイル設定 */
            font-family: 'IPA Gothic', 'IPA Gothict', 'ＭＳ ゴシック', 'MS Gothic', monospace; 
            font-size: 10px; 
            line-height: 1; 
            letter-spacing: normal; 
            border: 1px solid #999;
            padding: 5px;
            white-space: pre;
            width: fit-content;
            background-color: #fff;
            color: #000;
        }
        #controlPanel, #serialPanel, #asciiPanel { 
            margin-top: 15px; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px;
        }
        label { display: inline-block; width: 150px; }
        pre { background-color: #f4f4f4; padding: 10px; overflow-x: auto; }
        /* 変換処理用の一時的なキャンバスは非表示 */
        #hiddenCanvas { display: none; } 
    </style>
</head>
<body>
    <h1>WebカメラAAとWeb Serial統合デモ</h1>

    <h2>1. カメラフィード</h2>
    <video id="cameraFeed" autoplay playsinline></video>
    <div>
        <button id="startCameraButton">カメラを起動</button>
        <button id="stopCameraButton" disabled>カメラを停止</button>
    </div>

    <hr>

    <h2>2. カメラ制御 (露出・コントラスト)</h2>
    <div id="controlPanel">
        <p>
            <label for="exposureSlider">露出時間 (Exposure Time): </label>
            <input type="range" id="exposureSlider" min="1" max="1000" value="100" step="1">
            <span id="exposureValue">100</span> ms
        </p>
        <p>
            <label for="contrastSlider">コントラスト (Contrast): </label>
            <input type="range" id="contrastSlider" min="0" max="1000" value="500" step="10">
            <span id="contrastValue">500</span>
        </p>
        <button id="applySettingsButton" disabled>設定を適用</button>
        <button id="showCapabilitiesButton" disabled>能力を表示</button>
        <h3>サポートされている能力</h3>
        <pre id="capabilitiesOutput">カメラ起動後に「能力を表示」ボタンを押してください。</pre>
    </div>

    <hr>

    <h2>3. アスキーアート表示 (48x32)</h2>
    <div id="asciiPanel">
        <button id="startAsciiButton" disabled>AA変換開始</button>
        <button id="stopAsciiButton" disabled>AA変換停止</button>
        <pre id="asciiOutput">AAがここに表示されます...</pre>
        <canvas id="hiddenCanvas"></canvas>
    </div>
    
    <hr>

    <h2>4. シリアル送信</h2>
    <div id="serialPanel">
        <button id="connectButton">シリアルポートに接続</button>
        <button id="disconnectButton" disabled>切断</button>
        <input type="text" id="sendDataInput" value="Hello from Web App!" style="width: 300px; margin-left: 20px;">
        <button id="sendButton" disabled>データ送信</button>
        <p id="statusMessage">状態: 未接続</p>
    </div>

    <script type="module">
        // 開発フォルダに置いたモジュールをインポート
        import { startCamera, stopCamera, getTrackInfo, applyCameraSettings } from './cameraFeed.js';
        import { connectSerialPort, sendData, disconnectSerialPort } from './serialSender.js';
        import { startAsciiConversion, stopAsciiConversion } from './asciiConverter.js'; 

        // --- UI要素の取得 ---
        // カメラ
        const videoElement = document.getElementById('cameraFeed');
        const startCameraButton = document.getElementById('startCameraButton');
        const stopCameraButton = document.getElementById('stopCameraButton');
        
        // カメラ制御
        const exposureSlider = document.getElementById('exposureSlider');
        const exposureValueSpan = document.getElementById('exposureValue');
        const contrastSlider = document.getElementById('contrastSlider');
        const contrastValueSpan = document.getElementById('contrastValue');
        const applySettingsButton = document.getElementById('applySettingsButton');
        const showCapabilitiesButton = document.getElementById('showCapabilitiesButton');
        const capabilitiesOutput = document.getElementById('capabilitiesOutput');

        // アスキーアート
        const startAsciiButton = document.getElementById('startAsciiButton');
        const stopAsciiButton = document.getElementById('stopAsciiButton');
        const asciiOutput = document.getElementById('asciiOutput');
        const hiddenCanvas = document.getElementById('hiddenCanvas');
        
        // シリアル
        const connectButton = document.getElementById('connectButton');
        const disconnectButton = document.getElementById('disconnectButton');
        const sendDataInput = document.getElementById('sendDataInput');
        const sendButton = document.getElementById('sendButton');
        const statusMessage = document.getElementById('statusMessage');


        // --- 1. カメラ機能のリスナー ---
        startCameraButton.addEventListener('click', async () => {
            const started = await startCamera(videoElement);
            if (started) {
                startCameraButton.disabled = true;
                stopCameraButton.disabled = false;
                applySettingsButton.disabled = false;
                showCapabilitiesButton.disabled = false;
                startAsciiButton.disabled = false;
                getTrackInfo(); 
            }
        });

        stopCameraButton.addEventListener('click', () => {
            stopCamera();
            stopAsciiConversion(); // カメラ停止時はAA変換も停止
            
            startCameraButton.disabled = false;
            stopCameraButton.disabled = true;
            applySettingsButton.disabled = true;
            showCapabilitiesButton.disabled = true;
            startAsciiButton.disabled = true;
            stopAsciiButton.disabled = true;
            capabilitiesOutput.textContent = 'カメラ起動後に「能力を表示」ボタンを押してください。';
        });

        // --- 2. カメラ制御機能のリスナー ---
        exposureSlider.addEventListener('input', () => { exposureValueSpan.textContent = exposureSlider.value; });
        contrastSlider.addEventListener('input', () => { contrastValueSpan.textContent = contrastSlider.value; });

        applySettingsButton.addEventListener('click', async () => {
            const exposureTime = parseInt(exposureSlider.value, 10);
            const contrast = parseInt(contrastSlider.value, 10); 
            await applyCameraSettings(exposureTime, contrast);
        });

        showCapabilitiesButton.addEventListener('click', () => {
            const info = getTrackInfo();
            if (info) {
                capabilitiesOutput.textContent = JSON.stringify(info.capabilities, null, 2);
            }
        });
        
        // --- 3. アスキーアート機能のリスナー ---
        startAsciiButton.addEventListener('click', () => {
            if (videoElement.srcObject) {
                // startAsciiConversion は videoElement から現在のフレームを読み取り、
                // asciiOutput に結果を書き込み、hiddenCanvas を使用します。
                startAsciiConversion(videoElement, asciiOutput, hiddenCanvas);
                startAsciiButton.disabled = true;
                stopAsciiButton.disabled = false;
            } else {
                alert('先にカメラを起動してください！');
            }
        });

        stopAsciiButton.addEventListener('click', () => {
            stopAsciiConversion();
            startAsciiButton.disabled = false;
            stopAsciiButton.disabled = true;
        });

        // --- 4. Web Serial 機能のリスナー ---
        connectButton.addEventListener('click', async () => {
            statusMessage.textContent = '状態: 接続中...';
            const connected = await connectSerialPort();
            if (connected) {
                statusMessage.textContent = '状態: 接続済み';
                connectButton.disabled = true;
                disconnectButton.disabled = false;
                sendButton.disabled = false;
            } else {
                statusMessage.textContent = '状態: 接続失敗またはキャンセル';
                connectButton.disabled = false;
                disconnectButton.disabled = true;
                sendButton.disabled = true;
            }
        });

        sendButton.addEventListener('click', async () => {
            const data = sendDataInput.value + '\n'; 
            await sendData(data);
        });

        disconnectButton.addEventListener('click', async () => {
            await disconnectSerialPort();
            statusMessage.textContent = '状態: 未接続';
            connectButton.disabled = false;
            disconnectButton.disabled = true;
            sendButton.disabled = true;
        });
    </script>
</body>
</html>