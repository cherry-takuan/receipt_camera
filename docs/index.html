<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>WebカメラAAとWeb Serial統合デモ</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        h1, h2 { border-bottom: 2px solid #eee; padding-bottom: 5px; }
        button { padding: 10px 15px; margin: 5px 10px 5px 0; cursor: pointer; }
        #cameraFeed {
            border: 2px solid #ccc;
            width: 640px; 
            height: 480px;
            display: block;
            margin-top: 10px;
            background-color: #000;
        }
        #asciiOutput {
            /* 印刷フォーマット (32文字 x 48行) に合わせて表示 */
            font-family: 'IPA Gothic', 'IPA Gothict', 'ＭＳ ゴシック', 'MS Gothic', monospace; 
            font-size: 10px; 
            line-height: 1; 
            letter-spacing: normal; 
            border: 1px solid #999;
            padding: 5px;
            white-space: pre;
            width: fit-content;
            background-color: #fff;
            color: #000;
        }
        #controlPanel, #serialPanel, #asciiPanel, #printPanel { 
            margin-top: 15px; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px;
        }
        label { display: inline-block; width: 150px; }
        pre { background-color: #f4f4f4; padding: 10px; overflow-x: auto; }
        /* 変換処理用の一時的なキャンバスは非表示 */
        #hiddenCanvas { display: none; } 
    </style>
</head>
<body>
    <h1>WebカメラAAとWeb Serial統合デモ</h1>
    <table>
        <tr>
            <td>
                <h2>1. カメラフィード</h2>
                <video id="cameraFeed" autoplay playsinline></video>
                <div>
                    <button id="startCameraButton">カメラを起動</button>
                    <button id="stopCameraButton" disabled>カメラを停止</button>
                </div>
            </td>
            <td>
                <h2>3. アスキーアート表示 (転置後 32x48)</h2>
                <div id="asciiPanel">
                    <button id="startAsciiButton" disabled>AA変換開始</button>
                    <button id="stopAsciiButton" disabled>AA変換停止</button>
                    <pre id="asciiOutput">AAがここに表示されます (32文字x48行の形式)...</pre>
                    <canvas id="hiddenCanvas"></canvas>
                </div>
            </td>
        </tr>
    </table>

    <hr>

    <h2>2. カメラ制御 (露出・コントラスト)</h2>
    <div id="controlPanel">
        <p>
            <label for="exposureSlider">露出時間 (Exposure Time): </label>
            <input type="range" id="exposureSlider" min="1" max="1000" value="100" step="1">
            <span id="exposureValue">100</span> ms
        </p>
        <p>
            <label for="contrastSlider">コントラスト (Contrast): </label>
            <input type="range" id="contrastSlider" min="0" max="1000" value="500" step="10">
            <span id="contrastValue">500</span>
        </p>
        <button id="applySettingsButton" disabled>設定を適用</button>
        <button id="showCapabilitiesButton" disabled>能力を表示</button>
        <h3>サポートされている能力</h3>
        <pre id="capabilitiesOutput">カメラ起動後に「能力を表示」ボタンを押してください。</pre>
    </div>

    <hr>
    
    <h2>4. 印刷/シリアル送信</h2>
    <div id="printPanel">
        <button id="printButton" disabled>AAを印刷機へ送信</button>
        <p style="margin-top: 10px;">※ シリアルポートに接続済みで、AA変換を開始している必要があります。</p>
    </div>

    <hr>

    <h2>5. Web Serial API 接続</h2>
    <div id="serialPanel">
        <button id="connectButton">シリアルポートに接続</button>
        <button id="disconnectButton" disabled>切断</button>
        <input type="text" id="sendDataInput" value="Hello from Web App!" style="width: 300px; margin-left: 20px;">
        <button id="sendButton" disabled>データ送信 (テスト用)</button>
        <p id="statusMessage">状態: 未接続</p>
    </div>

    <script type="module">
        // --- モジュールインポート ---
        import { startCamera, stopCamera, getTrackInfo, applyCameraSettings } from './cameraFeed.js';
        import { connectSerialPort, sendData, disconnectSerialPort } from './serialSender.js';
        import { startAsciiConversion, stopAsciiConversion, printAsciiArt } from './asciiConverter.js'; 

        // --- UI要素の取得 ---
        const videoElement = document.getElementById('cameraFeed');
        const startCameraButton = document.getElementById('startCameraButton');
        const stopCameraButton = document.getElementById('stopCameraButton');
        
        const exposureSlider = document.getElementById('exposureSlider');
        const exposureValueSpan = document.getElementById('exposureValue');
        const contrastSlider = document.getElementById('contrastSlider');
        const contrastValueSpan = document.getElementById('contrastValue');
        const applySettingsButton = document.getElementById('applySettingsButton');
        const showCapabilitiesButton = document.getElementById('showCapabilitiesButton');
        const capabilitiesOutput = document.getElementById('capabilitiesOutput');

        const startAsciiButton = document.getElementById('startAsciiButton');
        const stopAsciiButton = document.getElementById('stopAsciiButton');
        const asciiOutput = document.getElementById('asciiOutput');
        const hiddenCanvas = document.getElementById('hiddenCanvas');
        
        const printButton = document.getElementById('printButton'); 
        
        const connectButton = document.getElementById('connectButton');
        const disconnectButton = document.getElementById('disconnectButton');
        const sendDataInput = document.getElementById('sendDataInput');
        const sendButton = document.getElementById('sendButton');
        const statusMessage = document.getElementById('statusMessage');


        // --- 制御ボタンの有効/無効を更新するヘルパー関数 ---
        function updatePrintButtonState() {
            // シリアル接続済み (disconnectButtonが有効) かつ カメラ起動済み (stopCameraButtonが有効) の場合に印刷ボタンを有効化
            const isSerialReady = disconnectButton.disabled === false; 
            const isCameraOn = stopCameraButton.disabled === false;
            
            printButton.disabled = !(isSerialReady && isCameraOn);
        }
        
        // --- 1. カメラ機能のリスナー ---
        startCameraButton.addEventListener('click', async () => {
            const started = await startCamera(videoElement);
            if (started) {
                startCameraButton.disabled = true;
                stopCameraButton.disabled = false;
                applySettingsButton.disabled = false;
                showCapabilitiesButton.disabled = false;
                startAsciiButton.disabled = false;
                getTrackInfo(); 
                updatePrintButtonState(); 
            }
        });

        stopCameraButton.addEventListener('click', () => {
            stopCamera();
            stopAsciiConversion();
            
            startCameraButton.disabled = false;
            stopCameraButton.disabled = true;
            applySettingsButton.disabled = true;
            showCapabilitiesButton.disabled = true;
            startAsciiButton.disabled = true;
            stopAsciiButton.disabled = true;
            capabilitiesOutput.textContent = 'カメラ起動後に「能力を表示」ボタンを押してください。';
            updatePrintButtonState(); 
        });
        
        // --- 2. カメラ制御機能のリスナー ---
        exposureSlider.addEventListener('input', () => { exposureValueSpan.textContent = exposureSlider.value; });
        contrastSlider.addEventListener('input', () => { contrastValueSpan.textContent = contrastSlider.value; });

        applySettingsButton.addEventListener('click', async () => {
            const exposureTime = parseInt(exposureSlider.value, 10);
            const contrast = parseInt(contrastSlider.value, 10); 
            await applyCameraSettings(exposureTime, contrast);
        });

        showCapabilitiesButton.addEventListener('click', () => {
            const info = getTrackInfo();
            if (info) { capabilitiesOutput.textContent = JSON.stringify(info.capabilities, null, 2); }
        });
        
        // --- 3. アスキーアート機能のリスナー ---
        startAsciiButton.addEventListener('click', () => {
            if (videoElement.srcObject) {
                // AA変換を開始し、画面にリアルタイム表示
                startAsciiConversion(videoElement, asciiOutput, hiddenCanvas);
                startAsciiButton.disabled = true;
                stopAsciiButton.disabled = false;
            } else {
                alert('先にカメラを起動してください！');
            }
        });

        stopAsciiButton.addEventListener('click', () => {
            stopAsciiConversion();
            startAsciiButton.disabled = false;
            stopAsciiButton.disabled = true;
        });
        
        // --- 4. 印刷ボタンのリスナー ---
        printButton.addEventListener('click', async () => {
            // AA変換が開始されているか確認 (AA文字列の有無で簡易チェック)
            if (asciiOutput.textContent.trim() === 'AAがここに表示されます (32文字x48行の形式)...') {
                alert("❌ AA変換を開始し、画面にAAが表示されている状態で行ってください。");
                return;
            }

            printButton.disabled = true; 
            
            // 画面表示中のAA文字列を直接取得して送信
            const success = await printAsciiArt(asciiOutput);
            
            if (success) {
                console.log("印刷データ送信フロー完了。");
            }
            updatePrintButtonState(); 
        });

        // --- 5. Web Serial 機能のリスナー ---
        connectButton.addEventListener('click', async () => {
            statusMessage.textContent = '状態: 接続中...';
            const connected = await connectSerialPort();
            if (connected) {
                statusMessage.textContent = '状態: 接続済み';
                connectButton.disabled = true;
                disconnectButton.disabled = false;
                sendButton.disabled = false;
                updatePrintButtonState(); 
            } else {
                statusMessage.textContent = '状態: 接続失敗またはキャンセル';
                connectButton.disabled = false;
                disconnectButton.disabled = true;
                sendButton.disabled = true;
                printButton.disabled = true; 
            }
        });
        
        disconnectButton.addEventListener('click', async () => {
            await disconnectSerialPort();
            statusMessage.textContent = '状態: 未接続';
            connectButton.disabled = false;
            disconnectButton.disabled = true;
            sendButton.disabled = true;
            updatePrintButtonState(); 
        });
        
        sendButton.addEventListener('click', async () => {
            const data = sendDataInput.value + '\n'; 
            await sendData(data);
        });
    </script>
</body>
</html>